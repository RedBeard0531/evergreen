axes:
- id: configuration
  values:
  - id: standalone
    variables:
        setup: standalone
  - id: repl
    variables:
        setup: repl
  - id: sharded
    variables:
        setup: sharded
- id: os
  values:
  - id: windows
    variables:
        build_distro: "windows_big"
  - id: linux
    run_on: "linux"
    tags: "posix"
    variables:
        build_distro: "linux_big"
        setup: repl
  - id: osx
    run_on: "osx"
    tags: "posix"
    variables:
        build_distro: "osx_big"


buildvariants:
- name: analysis
  run_on: "linux"
  tasks:
  - pre-task
  - post-task
- matrix_name: test
  matrix_spec:
      os: "*"
      configuration: "*"
  tasks:
  - name: "compile"
    run_on: ${build_distro}
    depends_on:
    - name: "pre-task"
      variant: "analysis"
  - name: "!.special"
    depends_on:
    - name: "compile"
      variant: # only run compile once per OS -- all configs will depend on it
        os: ${os}
        configuration: "standalone" #FIXME this is broken

tasks:
- name: "compile"
  tags: "special"
- name: "test1"
- name: "test2"
- name: "test3"
- name: "test4"
- name: "pre-task"
  tags: "special"
- name: "post-task"
  depends_on:
  - name: "!.special"
    variant: {"os":"*", "configuration":"*"}
  tags: "special"
